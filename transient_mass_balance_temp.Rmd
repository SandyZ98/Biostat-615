---
title: "transient mass balance"
author: "Abby Mauger"
date: "2023-11-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(patchwork)
```

Using the first-order exponential integrator, we have

$$ C_{t+1} = E/Q\{1-exp(-Q/V\Delta t)\} + (C_{t}-C_R)exp(-Q/V\Delta t) +C_R $$
$$ E = n * CO2rate $$ is the CO2 emission rate in ug/s

assume consistent units: CO2rate is in ug/s/person, Q is in m3/s, C is in ug/m3, V is in m3, and t is in s.

We want to minimize the sum of squares between the predicted C and observed C

$$ \sum_{i=1}^{n} (\hat{C_{i}} - C_{i})^2 = \sum_{i=1}^{n}(E/Q\{1-exp(-Q/V\Delta t)\} + (C_{i-1}-C_R)exp(-Q/V\Delta t) +C_R) -C_i)^2$$

Taking the first derivative with respect to Q we get:

$$ \frac{\partial}{\partial Q} = \sum_{i=1}^{n} 2(\hat{C_i}-C_i)[(-E/Q^2)(1-exp^{-Q/V\Delta t})+(E/Q + C_R-C_{i-1})
exp(-Q/V\Delta t)(\Delta t/V)]$$


Second derivative with respect to Q




One-dimensional optimization with Newton-Raphson:

Future things to implement: estimate envCO2, estimate CO2 emissions without persondata or with limited persondata

A better way to format persondata and match it to the CO2data
-- currently, persondata needs to start at 0 (first CO2 measurement) and end at the number of hours from the first to last CO2 measurement. If it is a 24 hour period, this is pretty simple. If it is >24 hours, care must be taken to make sure persondata is formatted properly

```{r}
# simulated data for testing
persondata <- data.frame(
  time = c(0, 8, 8, 12, 12, 13, 13, 17, 24),
  n = c(0, 15, 2, 0, 0, 15, 2, 0, 0),
  age = c(0, 8, 30, 8, 30, 8, 30, 0, 0),
  gender = rep(NA, 9),
  MET = c(NA, 3, 1.8, 3, 1.8, 3, 2, NA, NA),
  CO2rate = rep(NA, 9)
)

freq=100
volume=500
envCO2=400
Q = .01

simdata <- simulateData(persondata = persondata,
                        volume=volume, 
                        ventilation_rate = Q, 
                        CO2var = 1,
                        method='Exponential', 
                        freq=freq)

CO2 = simdata$CO2


ggplot(simdata, aes(x=time, y=CO2)) + 
  geom_line() +   
  geom_smooth()
```


```{r}
estimate_ventilation(freq=freq, 
                     CO2=simdata$CO2, 
                     volume=volume, 
                     envCO2=envCO2, 
                     init.Q=2, 
                     temp=temp, 
                     persondata=persondata, 
                     method='NR', 
                     max.iter=1000, 
                     tol=1e-10,
                     record.steps=TRUE) -> vent

f.plot = ggplot(vent$steps, aes(x=iter, y=f)) +
      geom_line() +
      geom_point() +
      theme_bw() +
      labs(x="Iteration", y="f") +
      ggtitle("f")

df.plot = ggplot(vent$steps, aes(x=iter, y=df)) +
      geom_line() +
      geom_point() +
      theme_bw() +
      labs(x="Iteration", y="df") +
      ggtitle("df")

d2f.plot = ggplot(vent$steps, aes(x=iter, y=d2f)) +
      geom_line() +
      geom_point() +
      theme_bw() +
      labs(x="Iteration", y="d2f") +
      ggtitle("d2f")

Q.plot = ggplot(vent$steps, aes(x=iter, y=Q)) +
      geom_line() +
      geom_point() +
      theme_bw() +
      geom_abline(slope=0,
                  intercept=vent$est_ventilation,
                  color="red") +
      labs(x="Iteration", y="Q") +
      ggtitle("Q")

(f.plot + df.plot)/(d2f.plot + Q.plot)

```

```{r}
freq=1
volume=500
envCO2=380
Q = .8
temp =25
persondata <- data.frame(
  time = c(0, 8, 8, 12, 12, 13, 13, 17, 24),
  n = c(0, 15, 2, 0, 0, 15, 2, 0, 0),
  age = c(0, 8, 30, 8, 30, 8, 30, 0, 0),
  gender = rep(NA, 9),
  MET = c(NA, 3, 1.8, 3, 1.8, 3, 2, NA, NA),
  CO2rate = rep(NA, 9)
)
critpoints = c(3600/freq*8, 3600/freq*12, 3600/freq*13, 3600/freq*17)
simdata <- simulateData(persondata = persondata,
                        volume=volume, 
                        ventilation_rate = Q, 
                        envCO2=envCO2,
                        startCO2=envCO2,
                        CO2var = 1e-8,
                        method='Exponential', 
                        freq=freq)

CO2 = simdata$CO2
# testing Netwon method
emissions <- persondata_to_emission(persondata, temp, freq)
rates <- unique(emissions$nadj_CO2rate)


estimate_ventilation(freq=freq, 
                     CO2=simdata$CO2, 
                     volume=volume, 
                     init.Q=.8, 
                     temp=temp, 
                     critpoints=critpoints,
                     method='Newton', 
                     max.iter=1000, 
                     tol=1e-10,
                     E.init=c(0, 26.27030, 0, 26.86735, 0),
                     envCO2.init = c(380),
                     record.steps=TRUE,
                     verbose=TRUE) -> vent
plot(vent)

```

```{r}
# load data for testing
data = readxl::read_excel("Aranet4 0C1B8_2023-11-15T18_47_56-0500.xlsx")
data2 = readxl::read_excel("Aranet4 17877_2023-11-15T18_49_59-0500.xlsx")
times = data$`Time(dd/mm/yyyy)`
times = as.POSIXct(times, format = "%d/%m/%Y %I:%M:%S %p")
times2 = as.POSIXct(data2$`Time(dd/mm/yyyy)`, format = "%d/%m/%Y %I:%M:%S %p")
CO2 = data$`Carbon dioxide(ppm)`
CO22 = data2$`Carbon dioxide(ppm)`

ggplot(data=data.frame(times=times, CO2=CO2), aes(x=times, y=CO2)) + 
  geom_line()

ggplot(data=data.frame(times=times2, CO2=CO22), aes(x=times, y=CO2)) + 
  geom_line()

# fake persondata
persondata <- data.frame(
  time = c(0, 5, 18, 27, 40, 49, 55.03),
  n = c(6, 0, 6, 0, 6, 0, 0)
)

volume = .0254^3*321*378*114
envCO2 = 400

# 6 ACH minimum ventilation when occupied

# ACHPH = 3600Q/Volume

realdata <- estimate_ventilation(freq=120, 
                     CO2=CO2, 
                     volume=volume, 
                     envCO2=envCO2, 
                     init.Q=1, 
                     temp=temp, 
                     persondata=persondata, 
                     method='NR', 
                     max.iter=1000, 
                     tol=1e-10)

realdata$est_ventilation/volume*3600
```
